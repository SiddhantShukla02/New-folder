<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    header {
      background: #007bff;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .container {
      padding: 2rem;
    }
    .form-section {
      background: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, textarea, select {
      width: 100%;
      margin: 8px 0;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 0.7rem 1.5rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #0056b3;
    }

    /* Toast popup styling */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 9999;
      font-weight: bold;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.error {
      background: #dc3545;
    }
  </style>
</head>
<body>
  <header>
    <h2>Admin Dashboard</h2>
    <button id="logoutBtn">Logout</button>
    <script>
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        const res = await fetch("https://health-portal-8c9n.onrender.com/admin/logout", { credentials: "include" });
        if (res.ok) {
          window.location.replace("/admin/login");
        }
      });
    </script>
  </header>

  <div class="container">
    <div class="form-section">
      <h3>Add Hospital</h3>
      <input id="hospName" placeholder="Hospital Name" />
      <input id="hospAddress" placeholder="Address" />
      <input id="hospCity" placeholder="City" />
      <input id="hospState" placeholder="State" />
      <textarea id="hospDesc" placeholder="Description"></textarea>
      <input id="hospContact" placeholder="Contact Number" />
      <button id="addHospital">Add Hospital</button>
    </div>

    <div class="form-section">
      <h3>Add Doctor</h3>
      <input id="docName" placeholder="Doctor Name" />
      <input id="docSpecs" placeholder="Specializations (comma separated)" />
      <input id="docExp" placeholder="Experience (in years)" />
      <input id="docHosp" placeholder="Hospital ID (Make sure a valid ID is entered! )" />
      <button id="addDoctor">Add Doctor</button>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="toast"></div>

  <script>
    // --- Toast popup function ---
    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = `toast show ${isError ? "error" : ""}`;
      setTimeout(() => {
        toast.className = "toast";
      }, 3000);
    }

    // --- Authentication check ---
    async function checkAuth() {
      const res = await fetch("https://health-portal-8c9n.onrender.com/admin/check-session", { credentials: "include" });
      const data = await res.json();
      if (!data.loggedIn) {
        window.location.replace("/admin/login");
      }
    }

    // --- Add Hospital ---
    document.getElementById("addHospital").addEventListener("click", async () => {
      const name = hospName.value.trim(),
            address = hospAddress.value.trim(),
            city = hospCity.value.trim(),
            state = hospState.value.trim(),
            description = hospDesc.value.trim(),
            contact = hospContact.value.trim();

      const res = await fetch("https://health-portal-8c9n.onrender.com/admin/add-hospital", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, address, city, state, description, contact }),
        credentials: "include"
      });

      const data = await res.json();
      if (res.ok) {
        showToast(data.message || "✅ Hospital added successfully");
        hospName.value = "";
        hospAddress.value = "";
        hospCity.value = "";
        hospState.value = "";
        hospDesc.value = "";
        hospContact.value = "";
      } else {
        showToast(data.message || "❌ Error adding hospital", true);
      }
    });

    // --- Add Doctor ---
    document.getElementById("addDoctor").addEventListener("click", async () => {
      const name = docName.value.trim(),
            specializations = docSpecs.value.trim(),
            experience = docExp.value.trim(),
            hospital = docHosp.value.trim();

      const res = await fetch("https://health-portal-8c9n.onrender.com/admin/add-doctor", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, specializations, experience, hospital }),
        credentials: "include"
      });

      const data = await res.json();
      if (res.ok) {
        showToast(data.message || "✅ Doctor added successfully");
        docName.value = "";
        docSpecs.value = "";
        docExp.value = "";
        docHosp.value = "";
      } else {
        showToast(data.message || "❌ Error adding doctor", true);
      }
    });

    // --- Logout ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("https://health-portal-8c9n.onrender.com/admin/logout", { credentials: "include" });
      sessionStorage.clear();
      localStorage.clear();
      window.location.replace("/admin-login.html");
    });

    // --- Prevent back-forward cache ---
    window.addEventListener("pageshow", (event) => {
      if (event.persisted) {
        window.location.reload();
      }
    });

    // --- Disable caching ---
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.getRegistrations().then((regs) => {
        for (let reg of regs) reg.unregister();
      });
    }

    // --- Session recheck on load ---
    window.addEventListener("load", async () => {
      const response = await fetch("https://health-portal-8c9n.onrender.com/admin/check-session", { credentials: "include" });
      const data = await response.json();
      if (!data.loggedIn) {
        window.location.href = "/admin/login";
      }
    });

    checkAuth();
  </script>
</body>
</html>
